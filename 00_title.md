<!-- markdownlint-disable MD012 MD014 -->

# Vulnerability Scanning



## What are CVEs

* _C_ommon _V_ulnerabilities and _E_xposures

> Unique, common identifiers for publicly known information-security vulnerabilities in publicly released software packages
([Wikipedia](https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures))

* <https://cve.mitre.org/>
* <https://nvd.nist.gov/vuln/full-listing>


## Example - Heartbleed

* <https://nvd.nist.gov/vuln/detail/CVE-2014-0160>

> The (1) TLS and (2) DTLS implementations in OpenSSL 1.0.1 before 1.0.1g do not properly handle Heartbeat Extension packets, which allows remote attackers to obtain sensitive information from process memory via crafted packets that trigger a buffer over-read, as demonstrated by reading private keys, related to d1_both.c and t1_lib.c, [...]


## CVSS

* Common Vulnerability Scoring System

| Rating    |  Score |
| --- | ---: |
| None| 0.0 |
| Low   |   0.1 - 3.9 |
| Medium | 4.0 - 6.9|
| High | 7.0 - 8.9|
| Critical | 9.0 - 10.0|

[Heartbleed](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?name=CVE-2014-0160&vector=AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N&version=3.1&source=NIST)


Example: Privileges Required (PR)

|  | |
| --- | --- |
|None (N) |The attacker is unauthorized prior to attack, and therefore does not require any access to settings or files of the the vulnerable system to carry out an attack.
|Low (L) |The attacker requires privileges that provide basic user capabilities that could normally affect only settings and files owned by a user. Alternatively, an attacker with Low privileges has the ability to access only non-sensitive resources.
|High (H) |The attacker requires privileges that provide significant (e.g., administrative) control over the vulnerable component allowing access to component-wide settings and files.


## Scanning for vulnerabilties

* Operating system
  * Installed software packages
* Docker container images
* Application
  * Used libraries and frameworks

* Left-shift security
  * Integration into CI/ CD



### [GitHub](https://github.com/stefanfreitag/introToAwsMsk/issues/18)

* Scanning via integrations with GitHub apps, e.g. Whitesource Bolt
* Scan is executed on every commit

<img src="images/whitesource_bolt_found_vulnerabilities.png" alt="" height="300px"/>


Findings

<img src="images/whitesource_bolt_overview.png" alt="" height="600px"/>

CVSS = Commomn Vulnerability Scoring System


[Details](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-9251)

<img src="images/whitesource_bolt_example.png" alt="" height="600px"/>



### Container image scanning

* Various Docker image registries exist
  * [DockerHub](https://hub.docker.com/)
  * [AWS Elastic Container Registry](https://aws.amazon.com/de/ecr/)
  * [Google Container Registry](https://cloud.google.com/container-registry/?hl=de)
  * Self-hosted


#### AWS ECR

_Scan on Push_ feature

<img src="images/aws_ecr_repositories.png" alt="" height="450px"/>


Scanned images with high level information

<img src="images/aws_ecr_repositories_coretto_8.png" alt="" height="550px"/>


Detailed information of a scan

<img src="images/aws_ecr_repositories_coretto_8_scan_result.png" alt="" height="600px"/>


Retrieval via CLI

~~~bash
$ aws ecr describe-image-scan-findings
    --repository-name=coretto-8
    --image-id imageTag=latest | jq
        -r '.imageScanFindings.findingSeverityCounts'

{
  "LOW": 1,
  "MEDIUM": 2
}
~~~


#### trivy

> A Simple and Comprehensive Vulnerability Scanner for Containers, Suitable for CI.

<img src="images/trivy_scan_corretto_8.png" alt="" height="400px"/>


| OS  | Supported Versions  | Target Packages |
|  --- | ---  | --- |
| Alpine Linux  | 2.2 - 2.7, 3.0 - 3.10 |  apk |
| RH UBI  | 7, 8  | yum/rpm |  
| RHEL  | 6, 7, 8 | yum/rpm |
| CentOS |  6, 7  | yum/rpm |
| Amazon Linux| 1, 2  | apt/apt-get/dpkg |
| Debian  | wheezy, jessie, stretch, buster | apt/apt-get/dpkg |
| Ubuntu  | 16.04, 18.04, 18.10, 19.04 | apt/apt-get/dpkg |
| Distroless  | Any | apt/apt-get/dpkg |

Distroless: <https://github.com/GoogleContainerTools/distroless>

UBI: Universal Base Image


Trivy automatically detects the following files in the container and scans vulnerabilities in the application dependencies.

* Gemfile.lock
* Pipfile.lock
* poetry.lock
* composer.lock
* package-lock.json
* yarn.lock
* Cargo.lock



## Scanning for Java based projects

* OWASP Dependency-Check
* Supports Java and .NET


Invocation

* Command Line
* Ant Task
* Maven Plugin
* Gradle Plugin

Other Plugins

* Jenkins Plugin
* sbt Plugin
* SonarQube Plugin


### Gradle Plugin

~~~json
plugins {
    id "fr.brouillard.oss.gradle.jgitver" version "0.10.0-rc01"
    id "io.franzbecker.gradle-lombok" version "3.2.0"
    id "java"
    id "idea"
    id "org.owasp.dependencycheck" version "5.2.4"
}
~~~

<img src="images/gradle_tasks.png" alt="" height="350px"/>


| Task| Description |
| --- | ---|
|dependencyCheckAnalyze | Runs dependency-check against the project and generates a report.
|dependencyCheckAggregate | Runs dependency-check against a multi-project build and generates a report.
|dependencyCheckUpdate | Updates the local cache of the NVD data from NIST.
|dependencyCheckPurge | Deletes the local copy of the NVD. This is used to force a refresh of the data.


Scan information

<img src="images/gradle_tasks.png" alt="" height="350px"/>


Specifies if the build should be failed if a CVSS score equal to or above a specified level is identified.

~~~json
dependencyCheck {
    failBuildOnCVSS=6
}
~~~

<img src="images/gradle_scan_failed_job.png" alt="" height="350px"/>



## Scanning npm based projects

* Using _npm audit_
* Fail an audit only if the results include a vulnerability with a level of moderate or higher:

~~~bash
$ npm audit --audit-level=moderate --parseable | awk -F $'\t' '{print $2,$3,$5}'
handlebars high Prototype Pollution
handlebars high Arbitrary Code Execution
https-proxy-agent high Machine-In-The-Middle
[...]
https-proxy-agent high Machine-In-The-Middle
handlebars high Prototype Pollution
handlebars high Arbitrary Code Execution
handlebars moderate Denial of Service
dot moderate Command Injection
marked moderate Regular Expression Denial of Service
handlebars moderate Denial of Service
~~~


* The _npm audit_ command will exit with a 0 exit code if no vulnerabilities were found.
* If vulnerabilities were found the exit code will depend on the audit-level configuration setting.

~~~bash
$ npm audit --audit-level=moderate
$ echo $?
1
~~~


Fixing vulnerabilites

* Using _npm audit fix_
* Scan your project for vulnerabilities and automatically install any compatible updates to vulnerable dependencies
* Do a dry run to get an idea of what audit fix will do

~~~bash
$ npm audit fix --dry-run
added 1557 packages in 5.857s
fixed 9 of 14 vulnerabilities in 19625 scanned packages
  5 vulnerabilities required manual review and could not be updated
~~~

* After running _npm audit fix_

~~~bash
$ npm audit --audit-level=moderate  --parseable | awk -F $'\t' '{print $2,$3,$5}'
dot moderate Command Injection
marked moderate Regular Expression Denial of Service
~~~  



## Further information

* [AquaSec trivy](https://github.com/aquasecurity/trivy)
* [Clair](https://coreos.com/clair/docs/latest/)
* [CVSS](https://www.first.org/cvss/specification-document)
* [Dependency-Check](https://jeremylong.github.io/DependencyCheck/dependency-check-gradle/index.html)
* [npm audit](https://docs.npmjs.com/cli/audit)
* [Whitesource Bolt](https://bolt.whitesourcesoftware.com/)
* [Wikipedia on CVE](https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures)
* [Wikipedia on CVE Scoring System](https://en.wikipedia.org/wiki/Common_Vulnerability_Scoring_System)
